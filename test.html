<!DOCTYPE html>
<html>
<head>
    <title>Test Scraper API</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        #result { white-space: pre-wrap; background: #f0f0f0; padding: 10px; margin-top: 10px; }
        .error { color: red; }
        .success { color: green; }
        
        /* Statistics styles */
        .statistics {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin: 20px 0;
        }
        .statistics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        /* Table styles */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }
        .data-table th, .data-table td {
            border: 1px solid #ddd;
            padding: 12px;
            text-align: left;
        }
        .data-table th {
            background: #f4f4f4;
        }
        .description-cell {
            max-height: 50px;
            overflow: hidden;
            position: relative;
            cursor: pointer;
        }
        .description-cell.expanded {
            max-height: none;
        }
        .description-toggle {
            color: blue;
            text-decoration: underline;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h1>Test Scraper API</h1>
    <button onclick="sendRequest()">Send Request</button>
    <div id="status"></div>
    <div id="result"></div>

    <!-- Statistics Section -->
    <div class="statistics">
        <h2>Статистика поиска</h2>
        <div class="statistics-grid">
            <div class="stat-card">
                <h3>Количество объявлений</h3>
                <div id="total-count">-</div>
            </div>
            <div class="stat-card">
                <h3>Минимальная цена</h3>
                <div id="min-price">-</div>
            </div>
            <div class="stat-card">
                <h3>Максимальная цена</h3>
                <div id="max-price">-</div>
            </div>
            <div class="stat-card">
                <h3>Средняя цена</h3>
                <div id="avg-price">-</div>
            </div>
        </div>
    </div>

    <!-- Data Table -->
    <div class="table-container">
        <h2>Результаты поиска</h2>
        <table class="data-table">
            <thead>
                <tr>
                    <th>Название</th>
                    <th>Цена</th>
                    <th>Дата</th>
                    <th>Продавец</th>
                    <th>Описание</th>
                </tr>
            </thead>
            <tbody id="items-table">
            </tbody>
        </table>
    </div>

    <script>
        async function sendRequest() {
            const statusDiv = document.getElementById('status');
            const resultDiv = document.getElementById('result');
            const itemsTableBody = document.getElementById('items-table');

            statusDiv.innerHTML = 'Sending request...';
            resultDiv.innerHTML = '';
            
            try {
                const response = await fetch('http://localhost:8080/v1/scrap', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        url: 'https://www.avito.ru/moskva/tovary_dlya_kompyutera/komplektuyuschie/protsessory-ASgBAgICAkTGB~pm7gniZw?cd=1&q=i5+12400f'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                // Получаем HTML-контент
                const htmlContent = await response.text();
                
                // Создаем временный контейнер для HTML
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = htmlContent;

                // Теперь можем использовать querySelectorAll
                const items = [];
                const prices = [];

                // Находим все карточки товаров
                const productCards = tempContainer.querySelectorAll('[data-marker="item"]');
                console.log('Found products:', productCards.length); // Для отладки
                
                productCards.forEach(card => {
                    try {
                        // Извлекаем цену и конвертируем в число
                        const priceElement = card.querySelector('.price-text-_YGDY');
                        const priceText = priceElement ? priceElement.textContent.trim() : '0';
                        const price = parseFloat(priceText.replace(/[^\d]/g, ''));
                        if (!isNaN(price)) {
                            prices.push(price);
                        }

                        // Собираем данные о товаре
                        const item = {
                            title: card.querySelector('[itemprop="name"]')?.textContent.trim() || 'Нет названия',
                            price: priceText,
                            date: card.querySelector('[data-marker="item-date"]')?.textContent.trim() || 'Нет даты',
                            seller: card.querySelector('.style-seller-info-name')?.textContent.trim() || 'Нет продавца',
                            description: card.querySelector('.iva-item-description')?.textContent.trim() || 'Нет описания'
                        };
                        
                        items.push(item);
                    } catch (error) {
                        console.error('Error processing card:', error);
                    }
                });

                // Рассчитываем статистику
                const statistics = {
                    totalCount: items.length,
                    minPrice: Math.min(...prices),
                    maxPrice: Math.max(...prices),
                    avgPrice: prices.length ? prices.reduce((a, b) => a + b) / prices.length : 0
                };

                // Обновляем статистику на странице
                document.getElementById('total-count').textContent = statistics.totalCount;
                document.getElementById('min-price').textContent = `${statistics.minPrice.toLocaleString()} ₽`;
                document.getElementById('max-price').textContent = `${statistics.maxPrice.toLocaleString()} ₽`;
                document.getElementById('avg-price').textContent = `${Math.round(statistics.avgPrice).toLocaleString()} ₽`;

                // Очищаем и заполняем таблицу
                itemsTableBody.innerHTML = '';
                items.forEach(item => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${item.title}</td>
                        <td>${item.price}</td>
                        <td>${item.date}</td>
                        <td>${item.seller}</td>
                        <td class="description-cell">
                            ${item.description}
                            <div class="description-toggle">Развернуть</div>
                        </td>
                    `;
                    itemsTableBody.appendChild(row);
                });

                // Добавляем обработчики для описаний
                setupDescriptionToggles();
                
                statusDiv.innerHTML = '<span class="success">Данные успешно загружены!</span>';

            } catch (error) {
                console.error('Error:', error);
                statusDiv.innerHTML = '<span class="error">Ошибка загрузки данных!</span>';
                resultDiv.innerHTML = `Ошибка: ${error.message}`;
            }
        }

        function setupDescriptionToggles() {
            document.querySelectorAll('.description-cell').forEach(cell => {
                const toggle = cell.querySelector('.description-toggle');
                toggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    cell.classList.toggle('expanded');
                    toggle.textContent = cell.classList.contains('expanded') ? 'Свернуть' : 'Развернуть';
                });
            });
        }
    </script>
</body>
</html> 